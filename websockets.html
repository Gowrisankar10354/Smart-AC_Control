<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Intelligent Control Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Theme Variables & Base (Inspired by earlier well-received version) --- */
        :root {
            --bg-primary: #111827;    /* Gray 900 */
            --bg-card: #1f2937;      /* Gray 800 */
            --bg-element: #374155;  /* Gray 700 for interactable elements */
            --text-primary: #e5e7eb;  /* Gray 200 */
            --text-secondary: #9ca3af;/* Gray 400 */
            --accent-purple: #a78bfa; /* Purple 400 */
            --highlight-active: #22d3ee; /* Cyan 400 */
            --highlight-filled: #67e8f9; /* Cyan 300 (lighter fill) */
            --highlight-temp-change: #f59e0b; /* Orange 500 */
            --status-connected: #34d399; /* Emerald 400 */
            --status-disconnected: #f87171; /* Red 400 */
            --border-color: #4b5563; /* Gray 600 */
        }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            overscroll-behavior-y: contain; /* Prevent pull-to-refresh on mobile for better PWA feel */
        }
        .card {
            background-color: var(--bg-card);
            border-radius: 1.25rem; /* 20px */
            padding: 1.5rem; /* 24px */
            box-shadow: 0 8px 16px -4px rgba(0,0,0,0.3), 0 4px 6px -2px rgba(0,0,0,0.15);
            display: flex; flex-direction: column;
            border: 1px solid var(--border-color);
        }
        .section-title {
            color: var(--accent-purple); font-size: 1.125rem; /* 18px */
            font-weight: 600; text-align: center; margin-bottom: 1.25rem;
        }

        /* Animations */
        @keyframes subtlePulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.75; } }
        .interactive-button { transition: transform 0.1s ease-out, background-color 0.2s ease, box-shadow 0.2s ease; }
        .interactive-button:hover { filter: brightness(1.1); }
        .interactive-button:active { transform: scale(0.95); filter: brightness(0.9); }
        
        /* App Header */
        #appHeaderGlobal {
            text-align: center; padding: 1.5rem 1rem 1rem 1rem; width: 100%;
            background-color: var(--bg-primary); 
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem; 
        }
        #appHeaderGlobal h1 {
            font-size: clamp(1.75rem, 5vw, 2.5rem); 
            font-weight: 700; color: var(--text-primary); letter-spacing: -0.01em;
            text-shadow: 0 0 10px rgba(167, 139, 250, 0.3); 
        }
        #appHeaderGlobal p { color: var(--text-secondary); margin-top: 0.25rem; font-size: clamp(0.875rem, 2.5vw, 1rem); }
        .status-display-header { display: flex; align-items: center; justify-content: center; margin-top: 0.75rem; gap: 0.5rem;}
        .status-dot-header { width: 0.75rem; height: 0.75rem; border-radius: 50%; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .status-dot-header.connected { background-color: var(--status-connected); box-shadow: 0 0 8px var(--status-connected); animation: subtlePulse 1.5s infinite; }
        .status-dot-header.disconnected { background-color: var(--status-disconnected); box-shadow: 0 0 8px var(--status-disconnected); }
        .status-text-header { font-size: 0.875rem; font-weight: 500; }
        .status-text-header.connected { color: var(--status-connected); }
        .status-text-header.disconnected { color: var(--status-disconnected); }

        /* AC Controls - Temperature animation */
        .temp-display-val { transition: color 0.3s ease, transform 0.3s ease; }
        .temp-changing { transform: scale(1.15) !important; color: var(--highlight-temp-change) !important; }
        .currentModeIcon i.mode-active { animation: subtlePulse 2s infinite ease-in-out; }


        /* Fan Speed UI (Desktop - Vertical, LOW at bottom, fills up) */
        .fan-speed-module-desktop { display: flex; flex-direction: column; align-items: center; height: 100%; }
        .fan-speed-bar-container-desktop {
            display: flex; flex-direction: column-reverse; /* LOW at bottom, fills upwards */
            align-items: center; width: 64px; margin-bottom: 1rem; padding: 0.375rem;
            background-color: var(--bg-primary); border-radius: 0.5rem; border: 1px solid var(--border-color);
            flex-grow: 1; justify-content: flex-start; /* Align items to the start (bottom due to reverse) */
        }
        .fan-speed-level-desktop {
            width: 100%; height: 1.75rem; margin-top: 0.25rem; /* spacing between levels */
            border-radius: 0.25rem; background-color: var(--bg-element);
            transition: all 0.2s ease-out;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.75rem; color: var(--text-secondary); cursor: pointer;
            border: 1px solid transparent;
        }
        .fan-speed-level-desktop:first-child { margin-top: 0; } /* No margin for the actual first item (bottom) */
        .fan-speed-level-desktop.filled { background-color: var(--highlight-filled); color: var(--bg-primary); }
        .fan-speed-level-desktop.active {
            background-color: var(--highlight-active); color: white;
            border-color: var(--highlight-active);
            box-shadow: 0 0 10px -2px var(--highlight-active), inset 0 0 5px rgba(255,255,255,0.2);
            transform: scale(1.05);
        }
        
        /* Fan Speed UI (Mobile - Horizontal, LOW on left, fills right) */
        .fan-speed-module-mobile { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .fan-speed-bar-container-mobile {
            display: flex; flex-direction: row; align-items: stretch; width: 100%; height: 2.5rem; margin-bottom: 0.75rem; padding: 0.25rem;
            background-color: var(--bg-primary); border-radius: 0.5rem; border: 1px solid var(--border-color);
            justify-content: space-around;
        }
        .fan-speed-level-mobile {
            flex-grow: 1; height: 100%; margin-left: 0.25rem; border-radius: 0.25rem; background-color: var(--bg-element);
            transition: all 0.2s ease-out; display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.75rem; color: var(--text-secondary); cursor: pointer; border: 1px solid transparent;
        }
        .fan-speed-level-mobile:first-child { margin-left: 0; }
        .fan-speed-level-mobile.filled { background-color: var(--highlight-filled); color: var(--bg-primary); }
        .fan-speed-level-mobile.active {
            background-color: var(--highlight-active); color: white; border-color: var(--highlight-active);
            box-shadow: 0 0 8px -2px var(--highlight-active), inset 0 0 4px rgba(255,255,255,0.15);
            transform: scale(1.03);
        }
        .fan-buttons button { 
            width: 2.75rem; height: 2.75rem; border-radius: 0.625rem; background-color: var(--bg-element);
            color: var(--text-primary); display: flex; align-items: center; justify-content: center;
        }
         .fan-buttons button:hover { background-color: var(--accent-purple); }

        /* Relay Toggles */
        .toggle-label { background-color: var(--bg-element); height: 2rem; width: 3.5rem; border-radius: 1rem; position: relative; }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--highlight-active); }
        .toggle-circle {
            background-color: #ffffff; 
            width: 1.5rem; height: 1.5rem; border-radius: 50%; position: absolute;
            top: 0.25rem; left: 0.25rem;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 2px solid transparent; 
        }
        .toggle-checkbox:checked + .toggle-label .toggle-circle { transform: translateX(calc(3.5rem - 2rem)); border-color: var(--highlight-active); }
        .toggle-checkbox:not(:checked) + .toggle-label .toggle-circle { border-color: var(--bg-element); }

        /* Mobile Menu (Slide-out) */
        #mobileMenuDrawer {
            background-color: var(--bg-card); 
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-100%);
            box-shadow: 5px 0 25px -5px rgba(0,0,0,0.4);
            color: var(--text-primary); width: 17rem; /* Approx 272px */
        }
        #mobileMenuDrawer.open { transform: translateX(0); }
        .menu-header { padding: 1.25rem; border-bottom: 1px solid var(--border-color); }
        .menu-header-title {
             color: var(--accent-purple);
             font-size: 1.2rem; /* Increased size */
             font-weight: 700; /* Bolder */
             letter-spacing: 0.02em;
             text-shadow: 0 0 5px rgba(167, 139, 250, 0.2); /* Subtle glow matching global header */
        }
        .menu-item-action { 
            display: flex; align-items: center; justify-content: center;
            background-color: var(--accent-purple); color: white;
            padding: 0.75rem 1rem; margin: 1rem 1.25rem; border-radius: 0.5rem;
            font-weight: 600; text-align: center;
            transition: background-color 0.15s ease, transform 0.1s ease; box-shadow: 0 4px 10px -2px rgba(167, 139, 250, 0.4);
        }
        .menu-item-action:hover { background-color: #8b5cf6; /* Purple 500 */}
        .menu-item-action:active {transform: scale(0.96);}
        .menu-item {
            display: flex; align-items: center; gap: 0.875rem; /* 14px */
            padding: 0.875rem 1.25rem; font-size: 1rem; 
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.15s ease; color: var(--text-primary);
        }
        .menu-item i { width: 1.125rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;}
        .menu-item:hover { background-color: var(--bg-element); }
        .menu-item.active-nav { background-color: var(--bg-element); color: var(--highlight-active); font-weight: 600;}
        .menu-item.active-nav i { color: var(--highlight-active); }
        .menu-item:last-child { border-bottom: none; }

        /* Desktop Layout */
        .desktop-layout-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem; width: 100%; max-width: 1350px; padding: 0 1rem 1.5rem 1rem;
        }
        /*.card { height: 410px; /* Consistent card height  }*/
        
        /* Mobile Page Display */
        .mobile-page-container { display: none; }
        .mobile-page-container.active { 
            display: flex; flex-direction: column; width: 100%; padding: 0 1rem 1rem 1rem;
            animation: fadeInPage 0.3s ease-out;
        }
        @keyframes fadeInPage { from { opacity: 0.8; transform: translateY(10px); } to { opacity: 1; translateY(0px); } }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center antialiased">

    <!-- Global App Header -->
    <header id="appHeaderGlobal">
        <h1>Smart Control Hub</h1>
        <p>Manage your environment effortlessly via ESP8266</p>
        <div class="status-display-header">
            <div id="connectionStatusDot" class="status-dot-header disconnected"></div>
            <span id="connectionStatusText" class="status-text-header disconnected">Disconnected</span>
        </div>
    </header>
    
    <!-- Mobile Slide-Out Menu -->
    <aside id="mobileMenuDrawer" class="md:hidden fixed top-0 left-0 h-full shadow-2xl z-40 pt-0">
        <div class="menu-header flex items-center justify-between">
            <span class="menu-header-title">Navigation</span>
            <button id="closeMenuButton" class="text-xl p-2 rounded-md hover:bg-slate-700 transition-colors focus:outline-none" style="color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="flex flex-col">
            <a href="#" class="menu-item-action mobile-nav-link" data-page="acFanControlsMobilePage" data-title="AC & Fan Controls"><i class="fas fa-gamepad mr-2"></i>Controls</a>
            
            <a href="#" class="menu-item mobile-nav-link" data-page="acFanControlsMobilePage" data-title="AC & Fan Controls"><i class="fas fa-temperature-three-quarters fa-fw"></i>AC & Fan</a>
            <a href="#" class="menu-item mobile-nav-link" data-page="relaysMobilePage" data-title="System Relays"><i class="fas fa-sliders-h fa-fw"></i>Relays</a>
            <a href="#" class="menu-item mobile-nav-link" data-page="environmentMobilePage" data-title="Room Statistics"><i class="fas fa-chart-line fa-fw"></i>Environment</a>
        </nav>
    </aside>
    <div id="menuOverlay" class="md:hidden fixed inset-0 bg-black/70 z-30 hidden"></div>


    <!-- Main Content -->
    <main class="w-full flex flex-col items-center flex-grow">
        <!-- Mobile Top Menu Button (only visible on mobile) -->
        <div class="md:hidden w-full px-4 pt-3 pb-2 flex items-center justify-between sticky top-0 z-10" style="background-color: var(--bg-primary);">
            <button id="mobileMenuButton" class="text-2xl p-2 rounded-md hover:bg-slate-700/50 transition-colors focus:outline-none" style="color: var(--accent-purple);">
                <i class="fas fa-bars"></i>
            </button>
            <span id="mobilePageTitle" class="text-lg font-semibold text-center" style="color:var(--text-primary)">AC & Fan Controls</span>
            <div class="w-8"></div> <!-- Spacer for balance -->
        </div>

        <!-- DESKTOP GRID CONTAINER -->
        <div id="desktopGridContainer" class="desktop-layout-grid hidden md:grid">
             <!-- AC Controls: Card for Desktop -->
            <section class="card" id="acControlsDesktopContainer">
                <h2 class="section-title">Air Conditioner</h2>
                <div class="flex-grow flex flex-col justify-around">
                    <div class="flex justify-center">
                         <button id="powerButtonDesktop" class="w-20 h-20 rounded-full bg-red-600 text-white flex items-center justify-center text-3xl shadow-xl hover:bg-red-500 interactive-button">
                            <i class="fas fa-power-off"></i>
                        </button>
                    </div>
                    <div class="flex items-center justify-evenly">
                        <button id="tempDownButtonDesktop" class="w-14 h-14 rounded-full bg-sky-600 hover:bg-sky-500 text-white interactive-button text-2xl"><i class="fas fa-minus"></i></button>
                        <div class="text-center">
                            <div id="currentModeIconDesktop" class="currentModeIcon text-4xl mb-0.5 h-12 flex items-center justify-center"><i class="fas fa-snowflake text-sky-400"></i></div>
                            <div id="tempDisplayDesktop" class="temp-display-val text-5xl font-bold">24</div>
                            <div class="text-xs mt-0.5" style="color: var(--text-secondary);">°C</div>
                        </div>
                        <button id="tempUpButtonDesktop" class="w-14 h-14 rounded-full bg-emerald-600 hover:bg-emerald-500 text-white interactive-button text-2xl"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="flex justify-center">
                        <button id="modeButtonDesktop" class="w-14 h-14 rounded-full bg-purple-600 hover:bg-purple-500 text-white interactive-button text-xl"><i class="fas fa-cog"></i></button>
                    </div>
                </div>
            </section>

            <!-- Fan Speed: Card for Desktop -->
            <section class="card" id="fanSpeedDesktopContainer">
                <h2 class="section-title">Fan Speed</h2>
                <div class="fan-speed-module-desktop">
                    <div class="fan-speed-bar-container-desktop">
                        <!-- HTML order for LOW (bottom) to AUTO (top) to allow filling UP -->
                        <div class="fan-speed-level-desktop" data-speed="LOW">L</div>
                        <div class="fan-speed-level-desktop" data-speed="MEDIUM">M</div>
                        <div class="fan-speed-level-desktop" data-speed="HIGH">H</div>
                        <div class="fan-speed-level-desktop" data-speed="AUTO">A</div>
                    </div>
                    <div class="fan-buttons flex justify-center space-x-3 mt-auto">
                        <button id="fanSpeedDownButtonDesktop" title="Decrease Speed" class="interactive-button"><i class="fas fa-chevron-down"></i></button>
                        <button id="fanSpeedUpButtonDesktop" title="Increase Speed" class="interactive-button"><i class="fas fa-chevron-up"></i></button>
                    </div>
                </div>
            </section>
            
            <section class="card justify-center" id="environmentDesktopContainer">
                <h2 class="section-title">Room Environment</h2>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="p-4 bg-gray-700/80 rounded-lg">
                        <i class="fas fa-thermometer-half text-3xl mb-1.5" style="color: var(--highlight-active);"></i>
                        <div id="roomTempValueDesktop" class="text-2xl font-bold">0<span class="text-base">°C</span></div>
                        <div class="text-xs mt-0.5 text-gray-400">Temperature</div>
                    </div>
                    <div class="p-4 bg-gray-700/80 rounded-lg">
                        <i class="fas fa-tint text-3xl mb-1.5 text-sky-400"></i>
                        <div id="roomHumidityValueDesktop" class="text-2xl font-bold">0<span class="text-base">%</span></div>
                        <div class="text-xs mt-0.5 text-gray-400">Humidity</div>
                    </div>
                </div>
            </section>

            <section class="card" id="relaysDesktopContainer">
                <h2 class="section-title">System Relays</h2>
                <div class="space-y-3.5 flex-grow flex flex-col justify-center">
                     <div class="flex items-center justify-between p-3 bg-gray-700/80 rounded-md">
                        <span class="text-sm font-medium flex items-center"><i class="fas fa-lightbulb mr-2 text-yellow-400"></i>Main Light</span>
                        <div class="relative inline-block align-middle"><input type="checkbox" id="relay1ToggleDesktop" class="toggle-checkbox absolute opacity-0 w-0 h-0"/><label for="relay1ToggleDesktop" class="toggle-label block cursor-pointer"><span class="toggle-circle block"></span></label></div>
                    </div>
                     <div class="flex items-center justify-between p-3 bg-gray-700/80 rounded-md">
                        <span class="text-sm font-medium flex items-center"><i class="fas fa-fan mr-2 text-sky-400"></i>Room Fan</span>
                         <div class="relative inline-block align-middle"><input type="checkbox" id="relay2ToggleDesktop" class="toggle-checkbox absolute opacity-0 w-0 h-0"/><label for="relay2ToggleDesktop" class="toggle-label block cursor-pointer"><span class="toggle-circle block"></span></label></div>
                    </div>
                     <div class="flex items-center justify-between p-3 bg-gray-700/80 rounded-md">
                        <span class="text-sm font-medium flex items-center"><i class="fas fa-plug mr-2 text-emerald-400"></i>Aux Outlet</span>
                         <div class="relative inline-block align-middle"><input type="checkbox" id="relay3ToggleDesktop" class="toggle-checkbox absolute opacity-0 w-0 h-0"/><label for="relay3ToggleDesktop" class="toggle-label block cursor-pointer"><span class="toggle-circle block"></span></label></div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- MOBILE PAGES CONTAINER (Hosts mobile-specific layouts) -->
        <div id="mobilePagesContainer" class="md:hidden w-full">
            <div id="acFanControlsMobilePage" class="mobile-page-container">
                <section class="card mb-4">
                    <h2 class="section-title">Air Conditioner</h2>
                    <div class="flex-grow flex flex-col justify-around py-2">
                        <div class="flex justify-center"><button id="powerButtonMobile" class="w-20 h-20 rounded-full bg-red-600 text-white flex items-center justify-center text-3xl interactive-button"><i class="fas fa-power-off"></i></button></div>
                        <div class="flex items-center justify-evenly my-4">
                            <button id="tempDownButtonMobile" class="w-14 h-14 rounded-full bg-sky-600 text-white interactive-button text-2xl"><i class="fas fa-minus"></i></button>
                            <div class="text-center">
                                <div id="currentModeIconMobile" class="currentModeIcon text-4xl mb-0.5 h-12 flex justify-center items-center"><i class="fas fa-snowflake text-sky-400"></i></div>
                                <div id="tempDisplayMobile" class="temp-display-val text-5xl font-bold">24</div>
                                <div class="text-xs mt-0.5" style="color:var(--text-secondary)">°C</div>
                            </div>
                            <button id="tempUpButtonMobile" class="w-14 h-14 rounded-full bg-emerald-600 text-white interactive-button text-2xl"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="flex justify-center"><button id="modeButtonMobile" class="w-14 h-14 rounded-full bg-indigo-500 text-white interactive-button text-xl"><i class="fas fa-cog"></i></button></div>
                    </div>
                </section>
                <section class="card">
                    <h2 class="section-title">Fan Speed</h2>
                    <div class="fan-speed-module-mobile">
                        <div class="fan-speed-bar-container-mobile">
                            <div class="fan-speed-level-mobile" data-speed-mobile="LOW">L</div>
                            <div class="fan-speed-level-mobile" data-speed-mobile="MEDIUM">M</div>
                            <div class="fan-speed-level-mobile" data-speed-mobile="HIGH">H</div>
                            <div class="fan-speed-level-mobile" data-speed-mobile="AUTO">A</div>
                        </div>
                        <div class="fan-buttons flex justify-center space-x-3 mt-3">
                            <button id="fanSpeedDownButtonMobile" class="interactive-button"><i class="fas fa-chevron-left"></i></button>
                            <button id="fanSpeedUpButtonMobile" class="interactive-button"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </section>
            </div>
            
            <div id="relaysMobilePage" class="mobile-page-container">
                <section class="card"><h2 class="section-title">System Relays</h2>
                    <div class="space-y-4 flex-grow flex flex-col justify-center">
                         <div class="flex items-center justify-between p-3 bg-gray-700/80 rounded-md">
                            <span class="text-sm font-medium flex items-center"><i class="fas fa-lightbulb mr-2 text-yellow-400"></i>Main Light</span>
                            <div class="relative inline-block align-middle"><input type="checkbox" id="relay1ToggleMobile" class="toggle-checkbox absolute opacity-0 w-0 h-0"/><label for="relay1ToggleMobile" class="toggle-label block cursor-pointer"><span class="toggle-circle block"></span></label></div>
                        </div>
                         <div class="flex items-center justify-between p-3 bg-gray-700/80 rounded-md">
                            <span class="text-sm font-medium flex items-center"><i class="fas fa-fan mr-2 text-sky-400"></i>Room Fan</span>
                             <div class="relative inline-block align-middle"><input type="checkbox" id="relay2ToggleMobile" class="toggle-checkbox absolute opacity-0 w-0 h-0"/><label for="relay2ToggleMobile" class="toggle-label block cursor-pointer"><span class="toggle-circle block"></span></label></div>
                        </div>
                         <div class="flex items-center justify-between p-3 bg-gray-700/80 rounded-md">
                            <span class="text-sm font-medium flex items-center"><i class="fas fa-plug mr-2 text-emerald-400"></i>Aux Outlet</span>
                             <div class="relative inline-block align-middle"><input type="checkbox" id="relay3ToggleMobile" class="toggle-checkbox absolute opacity-0 w-0 h-0"/><label for="relay3ToggleMobile" class="toggle-label block cursor-pointer"><span class="toggle-circle block"></span></label></div>
                        </div>
                    </div>
                </section>
            </div>

            <div id="environmentMobilePage" class="mobile-page-container">
                <section class="card"><h2 class="section-title">Room Statistics</h2>
                    <div class="grid grid-cols-1 gap-3 text-center flex-grow content-center">
                        <div class="py-5 bg-gray-700/80 rounded-lg">
                            <i class="fas fa-thermometer-half text-3xl mb-1.5" style="color:var(--highlight-active)"></i>
                            <div id="roomTempValueMobile" class="text-2xl font-bold">0<span class="text-base">°C</span></div>
                            <div class="text-xs mt-0.5" style="color:var(--text-secondary)">Temperature</div>
                        </div>
                        <div class="py-5 bg-gray-700/80 rounded-lg">
                            <i class="fas fa-tint text-3xl mb-1.5 text-sky-400"></i>
                            <div id="roomHumidityValueMobile" class="text-2xl font-bold">0<span class="text-base">%</span></div>
                            <div class="text-xs mt-0.5" style="color:var(--text-secondary)">Humidity</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        <footer class="pb-6 pt-6 text-center text-xs w-full" style="color:var(--text-secondary);">
             © ESP8266 Intelligent Control Hub
        </footer>
    </main>
    
    <script>
        // --- WebSocket & State Variables ---
        let socket;
        const espIp = "192.168.4.1"; const espPort = 81; const wsUrl = `ws://${espIp}:${espPort}`;
        let currentTemp = 24, currentModeIndex = 0, isPowerOn = false;
        const acModes = [ 
            { name: "COOL", icon: "fa-snowflake", color: "text-sky-400" },
            { name: "DRY",  icon: "fa-water", color: "text-teal-400" }, // Using fa-water instead of fa-droplet for better visual
            { name: "HEAT", icon: "fa-sun", color: "text-yellow-400" },
            { name: "FAN",  icon: "fa-fan", color: "text-gray-500" }
        ];
        // Fan speed: LOW at bottom, AUTO at top. Cycle: LOW -> MED -> HIGH -> AUTO -> LOW
        const fanSpeedCycleOrder = ["LOW", "MEDIUM", "HIGH", "AUTO"]; 
        const fanSpeedVisualDesktop = ["LOW", "MEDIUM", "HIGH", "AUTO"]; // Visual order for desktop (bottom to top fill)
        const fanSpeedVisualMobile = ["LOW", "MEDIUM", "HIGH", "AUTO"]; // Visual order for mobile (left to right fill)
        let currentFanSpeed = fanSpeedCycleOrder[0]; // Default to LOW

        let relayStates = { relay1: false, relay2: false, relay3: false };
        let roomTemperature = 0, roomHumidity = 0;

        // --- DOM Elements ---
        const dom = {
            statusDot: document.getElementById('connectionStatusDot'),
            statusText: document.getElementById('connectionStatusText'),
            mobilePageTitle: document.getElementById('mobilePageTitle'),
            // Desktop AC
            ac: {
                power: document.getElementById('powerButtonDesktop'),
                tempDown: document.getElementById('tempDownButtonDesktop'),
                tempUp: document.getElementById('tempUpButtonDesktop'),
                mode: document.getElementById('modeButtonDesktop'),
                tempDisplay: document.getElementById('tempDisplayDesktop'),
                modeIcon: document.getElementById('currentModeIconDesktop'),
            },
            fanDesktop: {
                levels: {}, up: document.getElementById('fanSpeedUpButtonDesktop'), down: document.getElementById('fanSpeedDownButtonDesktop'),
                barContainer: document.querySelector('#fanSpeedDesktopContainer .fan-speed-bar-container-desktop')
            },
            relaysDesktop: {},
            envDesktop: { temp: document.getElementById('roomTempValueDesktop'), humidity: document.getElementById('roomHumidityValueDesktop')},
            // Mobile AC
            acMobile: {
                power: document.getElementById('powerButtonMobile'),
                tempDown: document.getElementById('tempDownButtonMobile'),
                tempUp: document.getElementById('tempUpButtonMobile'),
                mode: document.getElementById('modeButtonMobile'),
                tempDisplay: document.getElementById('tempDisplayMobile'),
                modeIcon: document.getElementById('currentModeIconMobile'),
            },
            fanMobile: {
                levels: {}, up: document.getElementById('fanSpeedUpButtonMobile'), down: document.getElementById('fanSpeedDownButtonMobile'),
                 barContainer: document.querySelector('#acFanControlsMobilePage .fan-speed-bar-container-mobile')
            },
            relaysMobile: {},
            envMobile: { temp: document.getElementById('roomTempValueMobile'), humidity: document.getElementById('roomHumidityValueMobile')},
            // Mobile Nav & Pages
            mobileMenuButton: document.getElementById('mobileMenuButton'),
            closeMenuButton: document.getElementById('closeMenuButton'),
            mobileMenuDrawer: document.getElementById('mobileMenuDrawer'),
            menuOverlay: document.getElementById('menuOverlay'),
            mobileNavLinks: document.querySelectorAll('#mobileMenuDrawer .mobile-nav-link'),
            mobilePages: { // Container for all mobile pages
                acFanControlsMobilePage: document.getElementById('acFanControlsMobilePage'),
                relaysMobilePage: document.getElementById('relaysMobilePage'),
                environmentMobilePage: document.getElementById('environmentMobilePage'),
            },
        };
        // Populate Fan Speed Level DOM elements (ensure query selectors are specific enough if structure varies)
        fanSpeedVisualDesktop.forEach(s => dom.fanDesktop.levels[s] = dom.fanDesktop.barContainer?.querySelector(`.fan-speed-level-desktop[data-speed="${s}"]`));
        fanSpeedVisualMobile.forEach(s => dom.fanMobile.levels[s] = dom.fanMobile.barContainer?.querySelector(`.fan-speed-level-mobile[data-speed-mobile="${s}"]`));

        ['relay1', 'relay2', 'relay3'].forEach(r => {
            dom.relaysDesktop[r] = document.getElementById(`${r}ToggleDesktop`);
            dom.relaysMobile[r] = document.getElementById(`${r}ToggleMobile`);
        });

        // --- UI Update Functions ---
        function updateConnectionStatusUI(isConnected) {
            dom.statusDot.classList.toggle('connected', isConnected);
            dom.statusDot.classList.toggle('disconnected', !isConnected);
            dom.statusText.textContent = isConnected ? 'Connected' : 'Disconnected';
            dom.statusText.classList.toggle('connected', isConnected);
            dom.statusText.classList.toggle('disconnected', !isConnected);
        }

        function updateAcSection(elements) {
            if(elements.tempDisplay) elements.tempDisplay.textContent = currentTemp;
            if(elements.modeIcon) {
                const mode = acModes[currentModeIndex];
                elements.modeIcon.innerHTML = `<i class="fas ${mode.icon} ${mode.color}"></i>`;
                elements.modeIcon.querySelector('i')?.classList.toggle('mode-active', isPowerOn);
            }
            if(elements.power) {
                elements.power.classList.toggle('bg-red-600', !isPowerOn);
                elements.power.classList.toggle('hover:bg-red-500', !isPowerOn);
                elements.power.classList.toggle('bg-green-500', isPowerOn);
                elements.power.classList.toggle('hover:bg-green-600', isPowerOn);
            }
        }
        
        function updateFanSpeedUIDesktop() {
            const currentSpeedIdx = fanSpeedCycleOrder.indexOf(currentFanSpeed);
            fanSpeedVisualDesktop.forEach((speed, visualIdx) => { // visualIdx from 0 (LOW) to 3 (AUTO)
                const el = dom.fanDesktop.levels[speed];
                if (!el) return;
                el.classList.remove('active', 'filled');
                if (isPowerOn) {
                    // Fill from bottom (LOW) upwards to the active speed
                    if (visualIdx <= currentSpeedIdx) el.classList.add('filled'); 
                    if (speed === currentFanSpeed) el.classList.add('active');
                }
            });
        }

        function updateFanSpeedUIMobile() {
            const currentSpeedIdx = fanSpeedCycleOrder.indexOf(currentFanSpeed);
             fanSpeedVisualMobile.forEach((speed, visualIdx) => { 
                const el = dom.fanMobile.levels[speed];
                if (!el) return;
                el.classList.remove('active', 'filled');
                if (isPowerOn) {
                    // Fill from left (LOW) rightwards to active speed
                    if (visualIdx <= currentSpeedIdx) el.classList.add('filled');
                    if (speed === currentFanSpeed) el.classList.add('active');
                }
            });
        }
        
        function updateRelaysSection(relayElementsDesktop, relayElementsMobile) {
            for (const relayId in relayStates) {
                if(relayElementsDesktop[relayId]) relayElementsDesktop[relayId].checked = relayStates[relayId];
                if(relayElementsMobile[relayId]) relayElementsMobile[relayId].checked = relayStates[relayId];
            }
        }
        function updateEnvironmentSection(envElementsDesktop, envElementsMobile) {
             if(envElementsDesktop.temp) envElementsDesktop.temp.innerHTML = `${roomTemperature}<span class="text-base font-normal"> °C</span>`;
             if(envElementsDesktop.humidity) envElementsDesktop.humidity.innerHTML = `${roomHumidity}<span class="text-base font-normal"> %</span>`;
             if(envElementsMobile.temp) envElementsMobile.temp.innerHTML = `${roomTemperature}<span class="text-base font-normal"> °C</span>`;
             if(envElementsMobile.humidity) envElementsMobile.humidity.innerHTML = `${roomHumidity}<span class="text-base font-normal"> %</span>`;
        }
        
        function updateAllUIs() {
            updateAcSection(dom.ac); updateAcSection(dom.acMobile);
            updateFanSpeedUIDesktop(); updateFanSpeedUIMobile();
            updateRelaysSection(dom.relaysDesktop, dom.relaysMobile);
            updateEnvironmentSection(dom.envDesktop, dom.envMobile);
        }

        // --- WebSocket Logic ---
         function connectWebSocket() {
            socket = new WebSocket(wsUrl);
            socket.onopen = () => { 
                updateConnectionStatusUI(true); 
                socket.send(JSON.stringify({ action: "get_initial_states" })); 
                sendAcState(); // Send current client AC state on connect
            };
            socket.onclose = () => { 
                updateConnectionStatusUI(false); 
                roomTemperature = 0; roomHumidity = 0; 
                // Reset relay states on disconnect for safety? Or maintain last known?
                // Object.keys(relayStates).forEach(k => relayStates[k] = false); 
                updateAllUIs(); 
                setTimeout(connectWebSocket, 3000); 
            };
            socket.onerror = (err) => { console.error("Socket Error:", err); updateConnectionStatusUI(false); socket.close(); /* ensure onclose fires */ };
            socket.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    console.log("ESP says:", data);
                    if (data.roomTemp !== undefined) roomTemperature = parseFloat(data.roomTemp).toFixed(1);
                    if (data.humidity !== undefined) roomHumidity = parseFloat(data.humidity).toFixed(1);
                    
                    if (data.relay_states) { // Expecting {"relay1":"OFF", "relay2":"ON", ...}
                        Object.keys(data.relay_states).forEach(key => {
                             if (relayStates.hasOwnProperty(key)) {
                                relayStates[key] = (data.relay_states[key] === "ON");
                             }
                        });
                    }
                    // Update single relay if message is specific to one (ESP could send this after a change)
                    if (data.type === "relay_update" && data.relay && data.state !== undefined) {
                        if (relayStates.hasOwnProperty(data.relay)) {
                             relayStates[data.relay] = (data.state === "ON");
                        }
                    }
                    updateAllUIs();
                } catch (error) { console.error("Parse Error:", error, "Data:", e.data); }
            };
        }
        function sendAcState() { 
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            const state = { type: "ac_control", power: isPowerOn ? "ON" : "OFF", temp: currentTemp, mode: acModes[currentModeIndex].name, fan: currentFanSpeed };
            socket.send(JSON.stringify(state));
            console.log("Sent AC state:", state);
        }
        function sendRelayState(relayId, isOn) { 
             if (!socket || socket.readyState !== WebSocket.OPEN) return;
            const cmd = { type: "relay_control", relay: relayId, state: isOn ? "ON" : "OFF" };
            socket.send(JSON.stringify(cmd));
            console.log("Sent Relay state:", cmd);
         }


        // --- Mobile Slide-Out Menu & Page Navigation Logic ---
        function showMobilePage(pageIdToShow, pageTitle) {
            Object.values(dom.mobilePages).forEach(container => { if(container) container.classList.remove('active'); });
            if (dom.mobilePages[pageIdToShow]) {
                dom.mobilePages[pageIdToShow].classList.add('active');
                dom.mobilePageTitle.textContent = pageTitle;
            }
            dom.mobileNavLinks.forEach(link => {
                link.classList.toggle('active-nav', link.dataset.page === pageIdToShow);
            });
            closeMobileMenu();
        }

        function openMobileMenu() {
            dom.mobileMenuDrawer.classList.add('open');
            dom.menuOverlay.classList.remove('hidden');
        }
        function closeMobileMenu() {
            dom.mobileMenuDrawer.classList.remove('open');
            dom.menuOverlay.classList.add('hidden');
        }

        dom.mobileMenuButton.addEventListener('click', openMobileMenu);
        dom.closeMenuButton.addEventListener('click', closeMobileMenu);
        dom.menuOverlay.addEventListener('click', closeMobileMenu);
        dom.mobileNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showMobilePage(link.dataset.page, link.dataset.title);
            });
        });

        // --- Event Handlers ---
        function handlePowerToggle(uiContext) { isPowerOn = !isPowerOn; updateAllUIs(); sendAcState(); }
        function handleTempChange(uiContext, increase) {
            const tempDisplayEl = uiContext === 'desktop' ? dom.ac.tempDisplay : dom.acMobile.tempDisplay;
            if (!isPowerOn) return;
            const oldTemp = currentTemp;
            if (increase && currentTemp < 30) currentTemp++;
            else if (!increase && currentTemp > 16) currentTemp--;

            if (oldTemp !== currentTemp && tempDisplayEl) {
                tempDisplayEl.classList.add('temp-changing');
                setTimeout(() => tempDisplayEl.classList.remove('temp-changing'), 350);
            }
            updateAllUIs(); sendAcState();
        }
        function handleModeChange(uiContext) { if (!isPowerOn) return; currentModeIndex = (currentModeIndex + 1) % acModes.length; updateAllUIs(); sendAcState(); }
        
        function handleFanCycle(increase) {
            if (!isPowerOn) return;
            let idx = fanSpeedCycleOrder.indexOf(currentFanSpeed);
            idx = increase ? (idx + 1) % fanSpeedCycleOrder.length : (idx - 1 + fanSpeedCycleOrder.length) % fanSpeedCycleOrder.length;
            currentFanSpeed = fanSpeedCycleOrder[idx];
            updateAllUIs(); sendAcState();
        }
        function handleFanLevelSelect(speed, uiContext) { // Added uiContext if specific updates needed
             if(!isPowerOn || !fanSpeedCycleOrder.includes(speed)) return;
            currentFanSpeed = speed;
            updateAllUIs(); sendAcState();
        }
        
        // Attach listeners to Desktop elements
        dom.ac.power?.addEventListener('click', () => handlePowerToggle('desktop'));
        dom.ac.tempUp?.addEventListener('click', () => handleTempChange('desktop', true));
        dom.ac.tempDown?.addEventListener('click', () => handleTempChange('desktop', false));
        dom.ac.mode?.addEventListener('click', () => handleModeChange('desktop'));
        
        dom.fanDesktop.up?.addEventListener('click', () => handleFanCycle(true)); 
        dom.fanDesktop.down?.addEventListener('click', () => handleFanCycle(false));
        fanSpeedVisualDesktop.forEach(s => dom.fanDesktop.levels[s]?.addEventListener('click', () => handleFanLevelSelect(s, 'desktop')));
        
        for (const id in dom.relaysDesktop) {
            dom.relaysDesktop[id]?.addEventListener('change', (e) => {
                 relayStates[id] = e.target.checked; // Update local state immediately for responsiveness
                 updateAllUIs(); // Reflect local change
                 sendRelayState(id, e.target.checked);
            });
        }

        // Attach listeners to Mobile elements
        dom.acMobile.power?.addEventListener('click', () => handlePowerToggle('mobile'));
        dom.acMobile.tempUp?.addEventListener('click', () => handleTempChange('mobile', true));
        dom.acMobile.tempDown?.addEventListener('click', () => handleTempChange('mobile', false));
        dom.acMobile.mode?.addEventListener('click', () => handleModeChange('mobile'));

        dom.fanMobile.up?.addEventListener('click', () => handleFanCycle(true));
        dom.fanMobile.down?.addEventListener('click', () => handleFanCycle(false));
        fanSpeedVisualMobile.forEach(s => dom.fanMobile.levels[s]?.addEventListener('click', () => handleFanLevelSelect(s, 'mobile')));

        for (const id in dom.relaysMobile) {
            dom.relaysMobile[id]?.addEventListener('change', (e) => {
                relayStates[id] = e.target.checked; // Update local state immediately
                updateAllUIs(); // Reflect local change
                sendRelayState(id, e.target.checked);
            });
        }

        // --- Initial Setup & Resize ---
        function handleWindowResize() {
            const isMobile = window.innerWidth < 768;
            document.getElementById('desktopGridContainer').style.display = isMobile ? 'none' : 'grid';
            document.getElementById('mobilePagesContainer').style.display = isMobile ? 'block' : 'none';
            // Sticky mobile header is part of the flow now, always potentially visible
            // The slide-out menu trigger is also managed within the mobile header part
            if (isMobile && !document.querySelector('.mobile-page-container.active')) {
                 showMobilePage('acFanControlsMobilePage', 'AC & Fan Controls'); // Default page on mobile
            }
        }
        
        window.addEventListener('load', () => {
            updateAllUIs(); 
            connectWebSocket(); 
            handleWindowResize();
            // Show default mobile page on load if mobile
            if (window.innerWidth < 768) {
                showMobilePage('acFanControlsMobilePage', 'AC & Fan Controls'); 
            }
        });
        window.addEventListener('resize', handleWindowResize);

    </script>
</body>
</html>
